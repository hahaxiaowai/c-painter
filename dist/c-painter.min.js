!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self)["c-painter"]=e()}(this,(function(){"use strict";function t(t){return t.toDataURL()}class e{constructor(t){this.initCanvas(t)}initCanvas(t){const e=document.getElementById(t);e?(this.width=e.clientWidth,this.height=e.clientHeight,this.canvas_storage=document.createElement("canvas"),this.setStyle(this.canvas_storage,e),this.ctx_storage=this.canvas_storage.getContext("2d"),this.canvas_base=document.createElement("canvas"),this.setStyle(this.canvas_base,e),this.ctx_base=this.canvas_base.getContext("2d"),this.canvas_draw=document.createElement("canvas"),this.setStyle(this.canvas_draw,e),this.ctx_draw=this.canvas_draw.getContext("2d"),e.appendChild(this.canvas_storage),e.appendChild(this.canvas_base),e.appendChild(this.canvas_draw)):console.error("请传入正确的Div id")}setStyle(t,e){t.width=e.clientWidth,t.height=e.clientHeight,t.style.position="absolute"}drawImage(t,e){if("string"==typeof t){const a=new Image;a.src=t,a.onload=()=>{this.clearCanvas(e),e.drawImage(a,0,0,this.width,this.height)}}else e.drawImage(t,0,0,this.width,this.height)}drawRect(t,e,a,s,i,n){"fill"===n?t.fillRect(e,a,s,i):strokeRect(e,a,s,i)}roundedRect(t,e,a,s,i,n){t.beginPath(),t.moveTo(e,a+n),t.lineTo(e,a+i-n),t.quadraticCurveTo(e,a+i,e+n,a+i),t.lineTo(e+s-n,a+i),t.quadraticCurveTo(e+s,a+i,e+s,a+i-n),t.lineTo(e+s,a+n),t.quadraticCurveTo(e+s,a,e+s-n,a),t.lineTo(e+n,a),t.quadraticCurveTo(e,a,e,a+n),t.stroke()}clearCanvas(t){t.clearRect(0,0,this.width,this.height)}imortImage(t){const e=new FileReader;e.readAsDataURL(t),e.onload=t=>{this.drawImage(t.currentTarget.result,this.ctx_base)}}exportImage(){return this.clearCanvas(this.ctx_storage),this.drawImage(this.canvas_base,this.ctx_storage),this.drawImage(this.canvas_draw,this.ctx_storage),t(this.canvas_storage)}}class a{constructor(t){this.drawMode="freePen",this.drawWidth=4,this.drawColor="#000000",this.boolDraw=!1,this.modes=["freePen","eraser","lineDash","text"],this.ctx=t.ctx_draw,this.init()}init(){this.ctx.lineWidth=this.drawWidth}changeMode(t){this.modes.indexOf(t)<0?console.error("非正确的绘制模式"):this.drawMode=t}changeWidth(t){"number"==typeof t?(this.drawWidth=t>0?t:1,this.ctx.lineWidth=t>0?t:1):console.error("输入正确的数字")}changeColor(t){!function(t){return/^#([0-9a-f]{6}|[0-9a-f]{3})$/i.test(t)||/^rgb\(([0-9]|[0-9][0-9]|25[0-5]|2[0-4][0-9]|[0-1][0-9][0-9])\,([0-9]|[0-9][0-9]|25[0-5]|2[0-4][0-9]|[0-1][0-9][0-9])\,([0-9]|[0-9][0-9]|25[0-5]|2[0-4][0-9]|[0-1][0-9][0-9])\)$/i.test(t)||/^rgba\(([0-9]|[0-9][0-9]|25[0-5]|2[0-4][0-9]|[0-1][0-9][0-9])\,([0-9]|[0-9][0-9]|25[0-5]|2[0-4][0-9]|[0-1][0-9][0-9])\,([0-9]|[0-9][0-9]|25[0-5]|2[0-4][0-9]|[0-1][0-9][0-9])\,(1|1.0|0.[0-9])\)$/i.test(t)}(t)?console.error("传入#,rgb,argb格式颜色"):(this.ctx.strokeStyle=t,this.ctx.fillStyle=t,this.drawColor=t)}changeLineStyle(t){t.lineCap&&["butt","round","square"].indexOf(t.lineCap)>=0&&(ctx.lineCap=t.lineCap),t.lineJoin&&["round","bevel","miter"].indexOf(t.lineJoin)>=0&&(ctx.lineJoin=t.lineJoin)}}class s{constructor(){this.storage=[],this.curIndex=0}add(t,e){if(e){const t=this.storage.length-e;this.storage.splice(e,t)}this.storage.push({index:this.storage.length,image:t}),this.curIndex=this.storage.length-1}next(){return this.curIndex!==this.storage.length-1&&(this.curIndex+=1),this.storage[this.curIndex]}prev(){return this.curIndex-1>=0&&(this.curIndex-=1),this.storage[this.curIndex]}}class i{constructor(t,e,a){this.initEvent(t,e,a)}initEvent(t,e,a){t.canvas_draw.onmousedown=a=>this.penDown(a,t.ctx_draw,e),t.canvas_draw.onmousemove=a=>this.penMove(a,t.ctx_draw,e),t.canvas_draw.onmouseup=s=>this.penUp(s,t,e,a),t.canvas_draw.onmouseleave=s=>this.penUp(s,t,e,a),t.canvas_draw.ontouchstart=a=>this.penDown(a,t.ctx_draw,e),t.canvas_draw.ontouchmove=a=>this.penMove(a,t.ctx_draw,e),t.canvas_draw.ontouchend=s=>this.penUp(s,t,e,a)}penDown(t,e,a){a.boolDraw=!0;const s=t.layerX,i=t.layerY;switch(a.drawMode){case"freePen":e.beginPath(),e.moveTo(s,i);break;case"eraser":e.clearRect(s-a.drawWidth/2,i-a.drawWidth/2,a.drawWidth,a.drawWidth)}}penMove(t,e,a){if(a.boolDraw){t.preventDefault();const s=t.layerX,i=t.layerY;switch(a.drawMode){case"freePen":e.lineTo(s,i),e.stroke();break;case"eraser":e.clearRect(s-a.drawWidth/2,i-a.drawWidth/2,a.drawWidth,a.drawWidth)}}}penUp(e,a,s,i){if(s.boolDraw){if("freePen"===s.drawMode)a.ctx_draw.closePath();s.boolDraw=!1,i.add(t(a.canvas_draw))}}}return class{constructor(t,n){this.doms=new e(t),this.storage=new s,this.state=new a(this.doms),this.event=new i(this.doms,this.state,this.storage)}next(){const t=this.storage.next();this.doms.drawImage(t.image,this.doms.ctx_draw)}prev(){const t=this.storage.prev();this.doms.drawImage(t.image,this.doms.ctx_draw)}importBaseImage(t){this.doms.imortImage(t)}downImage(){const t=this.doms.exportImage(),e=document.createElement("a");e.download="painter.jpg",e.href=t,e.click()}changeColor(t){this.state.changeColor(t)}changeWidth(t){this.state.changeWidth(t)}changeMode(t){this.state.changeMode(t)}}}));
